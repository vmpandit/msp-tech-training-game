<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSP Technician CTF Training - Net Works</title>
    <style>
        :root {
            --primary-navy: #002d74;
            --accent-red: #c10230;
            --light-gray: #f5f5f5;
            --dark-navy: #001a44;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-navy) 0%, var(--dark-navy) 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            font-size: 2.5rem;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .company-name {
            color: var(--accent-red);
            font-weight: bold;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #e0e0e0;
        }

        .header-controls {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: #fff;
            width: 45px;
            height: 45px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .icon-btn:hover {
            background: var(--accent-red);
            border-color: var(--accent-red);
            transform: translateY(-2px);
        }

        .game-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .info-card.timer-card {
            border-color: var(--accent-red);
            background: rgba(193, 2, 48, 0.2);
        }

        .info-label {
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
        }

        .info-value.timer {
            color: var(--accent-red);
        }

        .score-display {
            font-size: 1.8rem;
            color: var(--accent-red);
        }

        .game-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        button {
            padding: 10px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: var(--accent-red);
            color: #fff;
        }

        .btn-primary:hover {
            background: #a00228;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(193, 2, 48, 0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-hint {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 2px solid #ffc107;
        }

        .btn-hint:hover {
            background: rgba(255, 193, 7, 0.3);
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }

        .category {
            background: var(--primary-navy);
            padding: 20px 10px;
            text-align: center;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.95rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1);
        }

        .question-box {
            background: var(--primary-navy);
            padding: 40px 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.2);
            position: relative;
        }

        .question-box:hover:not(.answered):not(.failed) {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(193, 2, 48, 0.4);
            background: var(--accent-red);
            border-color: var(--accent-red);
        }

        .question-box.answered {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
            cursor: default;
        }

        .question-box.failed {
            background: rgba(244, 67, 54, 0.3);
            border-color: #f44336;
            cursor: pointer;
            opacity: 0.7;
        }

        .question-box.partial {
            background: rgba(255, 152, 0, 0.3);
            border-color: #ff9800;
            cursor: pointer;
        }

        .attempts-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--accent-red);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--primary-navy) 0%, var(--dark-navy) 100%);
            padding: 40px;
            border-radius: 15px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease;
            border: 3px solid var(--accent-red);
        }

        .modal-content.wide {
            max-width: 1000px;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--accent-red);
        }

        .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--accent-red);
        }

        .question-value {
            font-size: 1.5rem;
            color: var(--accent-red);
            font-weight: bold;
        }

        .question-text {
            font-size: 1.2rem;
            line-height: 1.6;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            border-left: 4px solid var(--accent-red);
        }

        .hint-section {
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }

        .hint-section.active {
            display: block;
        }

        .hint-text {
            color: #ffc107;
            font-size: 1rem;
            line-height: 1.5;
        }

        .answer-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }

        .answer-btn {
            padding: 15px;
            font-size: 1rem;
            text-align: left;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: #fff;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .answer-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.2);
            border-color: var(--accent-red);
            transform: translateX(5px);
        }

        .answer-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .answer-btn.correct {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }

        .answer-btn.incorrect {
            background: rgba(244, 67, 54, 0.3);
            border-color: #f44336;
        }

        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1rem;
        }

        .feedback.correct {
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4CAF50;
            color: #4CAF50;
        }

        .feedback.incorrect {
            background: rgba(244, 67, 54, 0.2);
            border: 2px solid #f44336;
            color: #f44336;
        }

        .feedback.retry {
            background: rgba(255, 152, 0, 0.2);
            border: 2px solid #ff9800;
            color: #ff9800;
        }

        .start-screen {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            max-width: 600px;
            margin: 50px auto;
            border: 3px solid var(--accent-red);
        }

        .start-screen h2 {
            color: var(--accent-red);
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .start-screen input {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            margin: 20px 0;
        }

        .start-screen input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-red), #ff4560);
            transition: width 0.3s ease;
        }

        .instructions-content {
            line-height: 1.8;
        }

        .instructions-content h3 {
            color: var(--accent-red);
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .instructions-content ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .instructions-content li {
            margin-bottom: 8px;
        }

        .warning-box {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .warning-box h3 {
            color: #ffc107;
            margin-bottom: 10px;
        }

        .report-section {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid var(--accent-red);
        }

        .report-section h3 {
            color: var(--accent-red);
            margin-bottom: 15px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-red);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #ccc;
            margin-top: 5px;
        }

        .category-performance {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
        }

        .category-name {
            font-weight: bold;
            color: var(--accent-red);
        }

        .performance-bar {
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            margin: 5px 0;
            overflow: hidden;
        }

        .performance-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.5s ease;
        }

        .performance-fill.low {
            background: linear-gradient(90deg, #f44336, #ff7961);
        }

        .performance-fill.medium {
            background: linear-gradient(90deg, #ff9800, #ffb74d);
        }

        @media (max-width: 1200px) {
            .game-board {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .game-board {
                grid-template-columns: repeat(2, 1fr);
            }

            h1 {
                font-size: 1.8rem;
            }

            .question-box {
                padding: 30px 10px;
                font-size: 1.5rem;
            }

            .modal-content {
                padding: 20px;
            }

            .game-info {
                grid-template-columns: 1fr;
            }

            .header-controls {
                position: static;
                justify-content: center;
                margin-top: 10px;
            }
        }

        @media (max-width: 480px) {
            .game-board {
                grid-template-columns: 1fr;
            }
        }

        .expired-message {
            text-align: center;
            padding: 40px;
            background: rgba(244, 67, 54, 0.2);
            border: 3px solid #f44336;
            border-radius: 15px;
            margin: 50px auto;
            max-width: 600px;
        }

        .expired-message h2 {
            color: #f44336;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-controls">
                <button class="icon-btn" onclick="showInstructions()" title="Instructions">‚ÑπÔ∏è</button>
                <button class="icon-btn" onclick="showLeaderboard()" title="Leaderboard">üèÜ</button>
            </div>
            <h1>üéØ MSP Technician CTF Training</h1>
            <p class="subtitle">Powered by <span class="company-name">Net Works</span> ‚Ä¢ Research Encouraged!</p>
        </header>

        <div id="startScreen" class="start-screen">
            <h2>Welcome to the Challenge!</h2>
            <p>Enter your name to begin your 72-hour MSP training journey</p>
            <input type="text" id="playerNameInput" placeholder="Enter your name" maxlength="30">
            <br>
            <button class="btn-primary" onclick="startGame()" style="margin-top: 20px; padding: 15px 40px; font-size: 1.2rem;">Start Game</button>
            <br><br>
            <button class="btn-secondary" onclick="showInstructions()">How to Play</button>
        </div>

        <div id="gameArea" style="display: none;">
            <div class="game-info">
                <div class="info-card">
                    <div class="info-label">Player</div>
                    <div class="info-value" id="playerName"></div>
                </div>
                <div class="info-card">
                    <div class="info-label">Score</div>
                    <div class="info-value score-display" id="currentScore">0</div>
                </div>
                <div class="info-card timer-card">
                    <div class="info-label">Time Remaining</div>
                    <div class="info-value timer" id="timeRemaining">72:00:00</div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>

            <div class="game-controls">
                <button class="btn-secondary" onclick="showReport()">View Progress</button>
                <button class="btn-secondary" onclick="resetGame()">New Game</button>
            </div>
            <br>

            <div class="game-board" id="gameBoard"></div>
        </div>

        <!-- Question Modal -->
        <div id="questionModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="question-value" id="questionValue"></div>
                    <button class="close-btn" onclick="closeModal()">&times;</button>
                </div>
                <div class="question-text" id="questionText"></div>
                
                <div class="hint-section" id="hintSection">
                    <div class="hint-text" id="hintText"></div>
                </div>
                
                <div style="text-align: center; margin: 15px 0;">
                    <button class="btn-hint" id="hintBtn" onclick="requestHint()">üí° Show Hint (-10% points)</button>
                </div>
                
                <div class="answer-options" id="answerOptions"></div>
                <div id="feedback" class="feedback" style="display: none;"></div>
            </div>
        </div>

        <!-- Instructions Modal -->
        <div id="instructionsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: var(--accent-red);">üìö How to Play</h2>
                    <button class="close-btn" onclick="closeInstructions()">&times;</button>
                </div>
                <div class="instructions-content">
                    <h3>üéØ Objective</h3>
                    <p>Test and improve your MSP technical knowledge across 10 critical domains. Complete as many challenges as possible within 72 hours!</p>

                    <h3>üéÆ Game Rules</h3>
                    <ul>
                        <li><strong>Two Chances:</strong> You get 2 attempts per question. After 2 wrong answers, you can still try but won't earn points.</li>
                        <li><strong>Point Values:</strong> Questions range from 100 points (basic) to 500 points (expert troubleshooting).</li>
                        <li><strong>Hints Available:</strong> Each question has a hint, but using it costs 10% of the question's points.</li>
                        <li><strong>Time Limit:</strong> You have 72 hours (3 days) from when you start to complete all challenges.</li>
                        <li><strong>Progress Saved:</strong> Your game automatically saves in your browser - you can take breaks!</li>
                    </ul>

                    <h3>‚úÖ Research is ENCOURAGED!</h3>
                    <p>This isn't a memory test - it's a learning tool! Feel free to use:</p>
                    <ul>
                        <li>Google and search engines</li>
                        <li>AI assistants (ChatGPT, Claude, etc.)</li>
                        <li>Microsoft Learn documentation</li>
                        <li>Vendor knowledge bases</li>
                        <li>Any other resources that help you learn!</li>
                    </ul>

                    <h3>üìä Performance Report</h3>
                    <p>At the end, you'll receive a detailed report showing your strengths and areas for improvement. This report automatically downloads so you can share it with your trainer.</p>

                    <h3>üí° Tips for Success</h3>
                    <ul>
                        <li>Start with 100-200 point questions to build confidence</li>
                        <li>Use hints wisely - the 10% penalty adds up!</li>
                        <li>Take your time to research and understand, not just guess</li>
                        <li>Read all explanations, even when you answer correctly</li>
                        <li>Document what you learn for future reference</li>
                    </ul>

                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn-primary" onclick="closeInstructions()" style="padding: 15px 40px;">Got It! Let's Play</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hint Confirmation Modal -->
        <div id="hintConfirmModal" class="modal">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2 style="color: #ffc107;">‚ö†Ô∏è Hint Penalty</h2>
                    <button class="close-btn" onclick="closeHintConfirm()">&times;</button>
                </div>
                <div class="warning-box">
                    <h3>Using a hint will reduce your potential points for this question by 10%</h3>
                    <p>Current potential: <span id="currentPotential"></span> points</p>
                    <p>After hint: <span id="afterHintPotential"></span> points</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn-primary" onclick="confirmHint()">Show Hint Anyway</button>
                    <button class="btn-secondary" onclick="closeHintConfirm()" style="margin-left: 10px;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Report Modal -->
        <div id="reportModal" class="modal">
            <div class="modal-content wide">
                <div class="modal-header">
                    <h2 style="color: var(--accent-red);">üìä Performance Report</h2>
                    <button class="close-btn" onclick="closeReport()">&times;</button>
                </div>
                <div id="reportContent"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn-primary" onclick="downloadReport()">üì• Download Report</button>
                    <button class="btn-secondary" onclick="closeReport()" style="margin-left: 10px;">Close</button>
                </div>
            </div>
        </div>

        <div id="leaderboardModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="color: var(--accent-red);">üèÜ Leaderboard</h2>
                    <button class="close-btn" onclick="closeLeaderboard()">&times;</button>
                </div>
                <div id="leaderboardContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Game data structure with hints
        const gameData = {
            categories: [
                {
                    name: "Active Directory",
                    questions: [
                        {
                            value: 100,
                            question: "What PowerShell cmdlet creates a new Active Directory user?",
                            hint: "Think about the PowerShell naming convention: Verb-Noun. The verb for creating objects is 'New'.",
                            options: [
                                "New-ADUser",
                                "Create-ADUser",
                                "Add-ADUser",
                                "Set-ADUser"
                            ],
                            correct: 0,
                            explanation: "New-ADUser is the correct cmdlet for creating new AD users. This follows PowerShell's Verb-Noun naming convention where 'New' creates objects."
                        },
                        {
                            value: 200,
                            question: "A client reports that Group Policy is not applying to a specific OU. You run gpresult /R and see 'Denied (Security Filtering)' for the GPO. What's the most likely cause?",
                            hint: "Security filtering requires both Read and Apply permissions. Think about what default group provides this access.",
                            options: [
                                "The Authenticated Users group was removed from the GPO security filtering",
                                "The GPO is disabled",
                                "The OU is in the wrong domain",
                                "GPO replication is failing"
                            ],
                            correct: 0,
                            explanation: "When Authenticated Users is removed without adding appropriate security groups (like Domain Computers), GPOs show as Denied in gpresult."
                        },
                        {
                            value: 300,
                            question: "You need to find all AD users with expired passwords and export them to CSV. Which PowerShell command accomplishes this?",
                            hint: "Get-ADUser has a -Filter parameter that can check the PasswordExpired property.",
                            options: [
                                "Get-ADUser -Filter {PasswordExpired -eq $true} -Properties PasswordExpired | Export-CSV",
                                "Get-ADUser -Filter * | Where {$_.PasswordLastSet -lt (Get-Date)} | Export-CSV",
                                "Export-ADUser -PasswordStatus Expired -Format CSV",
                                "Get-ADPasswordStatus -Expired | ConvertTo-CSV"
                            ],
                            correct: 0,
                            explanation: "Get-ADUser with -Filter parameter checking PasswordExpired property is the correct approach. You need -Properties to include PasswordExpired in the output."
                        },
                        {
                            value: 400,
                            question: "Event ID 4740 (account lockout) appears in the logs, but you need to find the SOURCE of the lockout attempts. Where should you look?",
                            hint: "Account lockouts are logged on a specific DC role, not all DCs. The event includes a field identifying the source computer.",
                            options: [
                                "Security Event Log on the PDC Emulator for Event ID 4740, check the 'Caller Computer Name' field",
                                "Check Event ID 4625 on all domain controllers",
                                "Review the Security log on the locked account's workstation for Event ID 4740",
                                "Check Application log on the domain controller for lockout source"
                            ],
                            correct: 0,
                            explanation: "Event ID 4740 logs only on PDC Emulator with Caller Computer Name showing the source. You'd then check Event ID 4625 on that source for details."
                        },
                        {
                            value: 500,
                            question: "You need to delegate helpdesk the ability to reset passwords and unlock accounts for a specific OU, but they should NOT be able to modify group memberships or move users. What's the best approach using the Delegation of Control Wizard?",
                            hint: "The principle of least privilege requires granting only specific permissions. There's a dedicated delegation option for password resets.",
                            options: [
                                "Create a dedicated security group, use Delegation Wizard to grant 'Reset user passwords and force password change' plus 'Read and write lockoutTime attribute'",
                                "Add helpdesk group to Account Operators built-in group",
                                "Grant Full Control on the OU to helpdesk group",
                                "Use Delegation Wizard to grant 'Modify all user properties'"
                            ],
                            correct: 0,
                            explanation: "Least privilege principle requires specific permissions only. Account Operators has too many permissions, Full Control is excessive, and modifying all properties includes dangerous permissions."
                        }
                    ]
                },
                {
                    name: "Entra ID",
                    questions: [
                        {
                            value: 100,
                            question: "Before assigning a license to a user in Entra ID (Azure AD), what property must be set?",
                            hint: "This property helps Microsoft determine which services are available in the user's region for compliance reasons.",
                            options: [
                                "UsageLocation",
                                "Country",
                                "Region",
                                "TenantLocation"
                            ],
                            correct: 0,
                            explanation: "UsageLocation must be set before license assignment due to compliance and service availability requirements."
                        },
                        {
                            value: 200,
                            question: "A user reports they can't sign in to a specific application. Sign-in logs show the attempt was blocked. What should you check first?",
                            hint: "Sign-in logs have a dedicated tab that shows which policies evaluated the sign-in attempt and their results.",
                            options: [
                                "Conditional Access policies in the Sign-in logs under the Conditional Access tab",
                                "User's license assignment",
                                "Application permissions",
                                "Network connectivity"
                            ],
                            correct: 0,
                            explanation: "Sign-in logs have a dedicated Conditional Access tab showing which policies evaluated and their results, making this the fastest troubleshooting path."
                        },
                        {
                            value: 300,
                            question: "You're creating a dynamic group for all Sales department users in the US. What's the correct membership rule syntax?",
                            hint: "Dynamic group rules use -eq for equality and -and for logical AND operations. Properties are referenced as user.propertyname.",
                            options: [
                                "(user.department -eq \"Sales\") -and (user.usageLocation -eq \"US\")",
                                "(user.department = \"Sales\") AND (user.country = \"US\")",
                                "department:Sales AND location:US",
                                "(user.Department -like \"Sales\" -and user.Location -eq \"United States\")"
                            ],
                            correct: 0,
                            explanation: "Dynamic group rules use -eq for equality, reference user.property format, and use -and for logical AND operations."
                        },
                        {
                            value: 400,
                            question: "A user has BOTH direct license assignment AND group-based license assignment. The group-based license includes Entra ID P1, while the direct assignment is Office 365 E3. What happens to license consumption?",
                            hint: "Microsoft's licensing system is smart enough to avoid double-billing, but having both types creates management issues.",
                            options: [
                                "User consumes only the licenses actually assigned (no double-billing), but it creates management confusion. Remove direct assignment.",
                                "User consumes both licenses (double-billing)",
                                "The direct assignment overrides the group assignment",
                                "An error occurs and the user has no licenses"
                            ],
                            correct: 0,
                            explanation: "Microsoft deduplicates license consumption, but having both direct and group-based causes management complexity. Best practice is group-based only."
                        },
                        {
                            value: 500,
                            question: "You need to implement Conditional Access requiring MFA for all cloud apps EXCEPT legacy authentication from the company VPN. Service accounts must be excluded. What's the most secure implementation order?",
                            hint: "Build from most specific to least: locations first, then exclusions, then the policy itself. Named locations identify specific IP ranges.",
                            options: [
                                "Create named location for VPN IPs ‚Üí Create exclusion group for service accounts ‚Üí Create CA policy requiring MFA for all cloud apps excluding legacy auth from VPN location ‚Üí Add exclusion group",
                                "Create CA policy excluding all legacy authentication ‚Üí Add VPN IP range to trusted locations",
                                "Enable Security Defaults and configure VPN exceptions",
                                "Create MFA policy for all users ‚Üí Disable legacy authentication globally"
                            ],
                            correct: 0,
                            explanation: "Named locations + exclusion groups + conditional access provides granular control. Security Defaults can't be customized. Order matters: location, exclusions, then policy."
                        }
                    ]
                },
                {
                    name: "Hybrid Identity",
                    questions: [
                        {
                            value: 100,
                            question: "What tool does Microsoft provide to find common AD issues before they cause Azure AD Connect sync failures?",
                            hint: "This tool's name suggests it 'fixes' identity issues. It's a free utility from Microsoft.",
                            options: [
                                "IdFix",
                                "ADCheck",
                                "SyncPrep",
                                "AzureADValidator"
                            ],
                            correct: 0,
                            explanation: "IdFix identifies and fixes common AD attribute issues like duplicate proxyAddresses, invalid characters, and format problems."
                        },
                        {
                            value: 200,
                            question: "Azure AD Connect sync shows an 'AttributeValueMustBeUnique' error for a user. What does this typically indicate?",
                            hint: "Certain attributes in Azure AD must be globally unique across all users. Email addresses are one such attribute.",
                            options: [
                                "A duplicate proxyAddress or UPN already exists in Azure AD",
                                "The user's password doesn't meet complexity requirements",
                                "The user is in the wrong OU",
                                "The sync service account lacks permissions"
                            ],
                            correct: 0,
                            explanation: "AttributeValueMustBeUnique indicates duplicate values for unique attributes like proxyAddresses, userPrincipalName, or mail."
                        },
                        {
                            value: 300,
                            question: "A company needs immediate password policy enforcement with minimal infrastructure. They have one on-premises DC and want hybrid identity. Which authentication method should you recommend?",
                            hint: "One method validates passwords in real-time against on-prem, while another syncs password hashes every 2 minutes. Combining both gives reliability.",
                            options: [
                                "Pass-Through Authentication with Password Hash Sync as backup",
                                "Password Hash Sync only",
                                "Federation with ADFS",
                                "Cloud-only authentication"
                            ],
                            correct: 0,
                            explanation: "PTA enforces on-prem policies immediately while PHS provides backup if DC fails. PHS alone has 2-minute delay. ADFS requires multiple servers (overkill)."
                        },
                        {
                            value: 400,
                            question: "Seamless SSO suddenly stops working for all users. Users now see login prompts for Office 365. What should you check first in Active Directory?",
                            hint: "Seamless SSO relies on a special computer account in AD with a certificate that must be renewed periodically.",
                            options: [
                                "Verify AZUREADSSOACC$ computer account exists and its certificate hasn't expired",
                                "Check if users are still synchronized",
                                "Verify DNS records for autodiscover",
                                "Restart Azure AD Connect sync service"
                            ],
                            correct: 0,
                            explanation: "The AZUREADSSOACC$ account and its certificate (auto-renews every 30 days) are critical for Seamless SSO. If renewal fails, SSO breaks for everyone."
                        },
                        {
                            value: 500,
                            question: "Azure AD Connect shows healthy sync, but a specific OU's users aren't syncing. You verify OU is in scope. Event logs show 'no-start-credentials' error. Describe your troubleshooting methodology including which tool to use, what to check, and likely resolutions.",
                            hint: "The Synchronization Service Manager provides detailed run history. 'No-start-credentials' specifically indicates an authentication problem with the connector account.",
                            options: [
                                "Open Synchronization Service Manager ‚Üí Review Connectors tab ‚Üí Check AD connector Run Profiles ‚Üí Verify connector account credentials haven't expired and have Replicating Directory Changes permissions ‚Üí Run Full Sync if credentials were reset",
                                "Restart Azure AD Connect Sync service ‚Üí Wait 30 minutes ‚Üí Check again",
                                "Run IdFix tool ‚Üí Fix errors ‚Üí Run delta sync",
                                "Uninstall and reinstall Azure AD Connect"
                            ],
                            correct: 0,
                            explanation: "The methodical approach: Sync Service Manager shows detailed run history, no-start-credentials indicates auth failure, verify account credentials and AD permissions, manual sync after fix."
                        }
                    ]
                },
                {
                    name: "Exchange Online",
                    questions: [
                        {
                            value: 100,
                            question: "What PowerShell cmdlet converts a user mailbox to a shared mailbox?",
                            hint: "The cmdlet modifies mailbox settings, and you specify the Type parameter.",
                            options: [
                                "Set-Mailbox -Type Shared",
                                "Convert-Mailbox -ToShared",
                                "New-SharedMailbox",
                                "Update-Mailbox -Shared $true"
                            ],
                            correct: 0,
                            explanation: "Set-Mailbox with -Type Shared parameter converts mailboxes. This also automatically blocks sign-in."
                        },
                        {
                            value: 200,
                            question: "A user needs to send email AS the shared mailbox (not 'on behalf of'). Which permission do they need?",
                            hint: "There are three permission types: FullAccess (read), SendOnBehalf (shows 'on behalf of'), and one that makes it appear FROM the mailbox.",
                            options: [
                                "SendAs permission granted with Add-RecipientPermission",
                                "FullAccess permission",
                                "SendOnBehalf permission",
                                "Owner permission"
                            ],
                            correct: 0,
                            explanation: "SendAs makes email appear FROM the mailbox. SendOnBehalf shows 'user on behalf of mailbox'. FullAccess is for reading only."
                        },
                        {
                            value: 300,
                            question: "50 users have FullAccess to a shared mailbox. Users report Outlook is extremely slow. What's likely causing this and how do you fix it?",
                            hint: "FullAccess permission has a feature that automatically adds the mailbox to Outlook, which can cause performance issues with many mailboxes.",
                            options: [
                                "Automapping is enabled for all 50 mailboxes. Remove and re-add permission with -AutoMapping $false for most users",
                                "The shared mailbox is too large. Archive older emails",
                                "Users need better computers",
                                "Exchange Online is experiencing issues"
                            ],
                            correct: 0,
                            explanation: "FullAccess enables automapping by default. 50 automapped mailboxes severely degrades Outlook performance. Most users should access via 'Open Another Mailbox'."
                        },
                        {
                            value: 400,
                            question: "You create a mail flow rule to add a disclaimer to all external emails. Users report 30-second delays for outbound mail. How do you optimize the rule?",
                            hint: "Mail flow rules process in order and can be resource-intensive. Targeting rules to only necessary messages and simplifying conditions improves performance.",
                            options: [
                                "Add condition 'recipient is external' instead of applying to all messages, use efficient regex for header parsing, consider rule ordering",
                                "Increase mail flow rule processing timeout",
                                "Remove the rule completely",
                                "Contact Microsoft support"
                            ],
                            correct: 0,
                            explanation: "Rules processing all messages cause delays. Proper conditions target only necessary messages. Complex regex in rules also impacts performance."
                        },
                        {
                            value: 500,
                            question: "A mailbox on litigation hold can't receive email. Primary mailbox: 45GB, Recoverable Items: 98GB (limit: 100GB). You must preserve data and restore email flow WITHOUT removing the hold. Document your complete remediation plan including cmdlets.",
                            hint: "The solution involves enabling archive, creating a special retention tag for Recoverable Items, and forcing the managed folder assistant to run.",
                            options: [
                                "Enable-Mailbox -Archive ‚Üí Set-Mailbox -ArchiveQuota 100GB -ArchiveWarningQuota 90GB ‚Üí New-RetentionPolicyTag (move to archive after 1 day) ‚Üí Apply to Recoverable Items ‚Üí Start-ManagedFolderAssistant ‚Üí Monitor with Get-MailboxFolderStatistics",
                                "Remove litigation hold temporarily ‚Üí Delete old items ‚Üí Re-enable hold",
                                "Increase Recoverable Items quota to 200GB",
                                "Export mailbox to PST ‚Üí Delete and recreate ‚Üí Import PST"
                            ],
                            correct: 0,
                            explanation: "Complete solution: Enable archive, ensure auto-expanding enabled, create specific retention tag for Recoverable Items, apply policy, force MFA run, verify results. Removing hold violates compliance requirements."
                        }
                    ]
                },
                {
                    name: "SharePoint Online",
                    questions: [
                        {
                            value: 100,
                            question: "What permission level allows users to view and download files but not edit or delete?",
                            hint: "This is the most basic permission level - users can only look at content.",
                            options: [
                                "Read",
                                "View",
                                "Visitor",
                                "Contribute"
                            ],
                            correct: 0,
                            explanation: "Read permission level provides view and download access without edit rights."
                        },
                        {
                            value: 200,
                            question: "A user breaks permission inheritance on a folder and chooses 'Remove inherited permissions'. What happens to existing user access?",
                            hint: "There are two options when breaking inheritance: one copies existing permissions, one removes them all.",
                            options: [
                                "All users immediately lose access except Site Collection Admins",
                                "Current permissions are copied, then inheritance is broken",
                                "Users keep access but can't be modified",
                                "Nothing changes"
                            ],
                            correct: 0,
                            explanation: "'Remove inherited permissions' deletes all access. 'Copy inherited permissions' preserves existing access. This is a common mistake causing access crisis."
                        },
                        {
                            value: 300,
                            question: "A document library with version history enabled has 500 major versions per file. A 10MB document has 500 versions. How much storage does this consume?",
                            hint: "Each version in SharePoint is stored as a complete copy of the file, not just changes.",
                            options: [
                                "Approximately 5GB (10MB √ó 500 versions)",
                                "10MB (only current version counts)",
                                "100MB (compressed storage)",
                                "1GB (optimized delta storage)"
                            ],
                            correct: 0,
                            explanation: "Each version stores the complete file. 500 versions √ó 10MB = 5GB. This is why version limits are critical for storage management."
                        },
                        {
                            value: 400,
                            question: "External sharing is enabled at tenant level but users still can't share. What's the proper troubleshooting hierarchy for SharePoint sharing settings?",
                            hint: "SharePoint sharing settings flow from most permissive to most restrictive. Lower levels can only be more restrictive, not more permissive.",
                            options: [
                                "Tenant settings ‚Üí Site Collection settings ‚Üí Library/folder settings (most specific wins)",
                                "Library settings ‚Üí Site settings ‚Üí Tenant settings",
                                "All levels must match exactly",
                                "Only tenant settings matter"
                            ],
                            correct: 0,
                            explanation: "Hierarchy flows down: Tenant can restrict Site, Site can restrict Library, but lower levels can't be more permissive than parent."
                        },
                        {
                            value: 500,
                            question: "Using PowerShell and PnP, audit all sites in tenant where versioning is unlimited AND version storage exceeds 50% of site storage. Then implement intelligent versioning with 180-day retention for all libraries over 100GB. Document your complete approach.",
                            hint: "PnP PowerShell is needed for API access at scale. You'll need to enumerate sites, get storage metrics, filter, then apply version policies.",
                            options: [
                                "Connect-PnPOnline ‚Üí Get-PnPTenantSite ‚Üí ForEach site: Get-PnPList -Includes EnableVersioning,MajorVersionLimit ‚Üí Calculate version storage from Get-PnPFolderStorageMetric ‚Üí Filter >50% ‚Üí Set-PnPList -EnableVersioning $true -MajorVersionLimit 100 -ExpireVersionsAfterDays 180",
                                "Use SharePoint admin center storage metrics report",
                                "Enable versioning limits globally in tenant settings",
                                "Contact Microsoft to increase storage"
                            ],
                            correct: 0,
                            explanation: "Complete solution requires: PnP PowerShell for API access, enumerate all sites/libraries, calculate version percentage, filter results, implement policy. Can't be done through admin GUI at scale."
                        }
                    ]
                },
                {
                    name: "Egnyte",
                    questions: [
                        {
                            value: 100,
                            question: "What are the three primary folder permission levels in Egnyte?",
                            hint: "The highest level can manage permissions, the middle can edit without managing permissions, and the lowest is read-only.",
                            options: [
                                "Owner, Full, Viewer",
                                "Admin, Edit, Read",
                                "Manager, Contributor, Reader",
                                "Full Control, Modify, Read Only"
                            ],
                            correct: 0,
                            explanation: "Egnyte uses Owner (all rights + permission management), Full (edit without permission management), and Viewer (read-only)."
                        },
                        {
                            value: 200,
                            question: "A user has individual 'Viewer' permission on a folder, but is also in a group with 'Full' permission. What access do they have?",
                            hint: "Egnyte has a unique rule about individual vs group permissions that differs from many other systems.",
                            options: [
                                "Viewer (individual permissions override group permissions, even if lower)",
                                "Full (highest permission wins)",
                                "No access (conflicting permissions)",
                                "Owner (escalated automatically)"
                            ],
                            correct: 0,
                            explanation: "Egnyte's critical rule: individual user permissions ALWAYS override group permissions, regardless of permission level. This catches many technicians off guard."
                        },
                        {
                            value: 300,
                            question: "Azure AD SCIM provisioning to Egnyte syncs every 40 minutes. A new employee was added to Azure AD security group 'Egnyte-Finance' 2 hours ago but still can't access Egnyte. What could be wrong?",
                            hint: "SCIM provisioning from Azure AD has limitations with group membership structure.",
                            options: [
                                "Nested groups aren't supported - the user must be directly added to the synced group",
                                "SCIM sync is broken",
                                "User needs to sign out and back in",
                                "Provisioning hasn't run yet"
                            ],
                            correct: 0,
                            explanation: "Azure AD SCIM provisioning sees only direct group membership. Users in nested groups aren't detected. This is a common onboarding issue."
                        },
                        {
                            value: 400,
                            question: "Egnyte Desktop App shows 'X File(s) Skipped' for multiple users. You click through and see 'File path too long' errors. What's the root cause and solution?",
                            hint: "Windows has a legacy file path limit that causes issues with deep folder structures. There's a Group Policy setting to address this in Windows 10+.",
                            options: [
                                "Windows 260-character path limit. Solutions: Enable long path support via Group Policy (Win 10+), shorten folder structure, use drive mapping to reduce base path length",
                                "Egnyte has a file size limit being exceeded",
                                "Users lack permissions",
                                "Desktop App needs reinstallation"
                            ],
                            correct: 0,
                            explanation: "Windows has 260-char path limit (including drive letter). Deep folder structures + long filenames exceed this. Win 10 1607+ can enable long paths via GPO: Computer Config ‚Üí Administrative Templates ‚Üí System ‚Üí Filesystem ‚Üí Enable Win32 long paths."
                        },
                        {
                            value: 500,
                            question: "Setting up Egnyte SSO with Azure AD for a domain configured before Feb 2019. SSO fails with 'Invalid SAML Response'. The Reply URL in Azure is https://domain.egnyte.com/samlconsumer. What's wrong and how do you fix it?",
                            hint: "Egnyte changed their SAML endpoint format at a specific date. Older domains use a different URL pattern than newer ones.",
                            options: [
                                "Legacy domains require /AzureAD suffix in Reply URL: https://domain.egnyte.com/samlconsumer/AzureAD. Update Azure app registration Reply URL and test",
                                "Certificate is using SHA-1 instead of SHA-256",
                                "User is set to Standard instead of Power User",
                                "Domain-specific issuer isn't enabled"
                            ],
                            correct: 0,
                            explanation: "Egnyte domains before Feb 20, 2019 have different SAML endpoint format requiring /AzureAD suffix. Newer domains use base endpoint. This is documented but easy to miss."
                        }
                    ]
                },
                {
                    name: "WatchGuard Firewall",
                    questions: [
                        {
                            value: 100,
                            question: "In Fireware policy configuration, what does 'Any' represent in the From/To fields?",
                            hint: "'Any' doesn't mean the entire internet - it refers to configured network zones on your firewall.",
                            options: [
                                "Any trusted or optional network",
                                "Any IP address on the internet",
                                "Any network configured on the firewall",
                                "Only the local network"
                            ],
                            correct: 0,
                            explanation: "'Any' represents any trusted, optional, or defined network - it does NOT include untrusted/external interfaces by default."
                        },
                        {
                            value: 200,
                            question: "You create a firewall policy allowing HTTP from Trusted to External. Traffic is denied. The policy shows in Firebox System Manager. What's the most likely cause?",
                            hint: "WatchGuard processes firewall rules in order. The first rule that matches determines the action.",
                            options: [
                                "Policy ordering - a deny rule above it is matching first",
                                "HTTP is blocked by default",
                                "Firewall is offline",
                                "Licenses expired"
                            ],
                            correct: 0,
                            explanation: "WatchGuard processes rules top-to-bottom in manual mode. A broader deny rule (like deny any-any) above your allow rule will match first and block traffic."
                        },
                        {
                            value: 300,
                            question: "A BOVPN tunnel shows Phase 1 and Phase 2 established, but traffic doesn't pass. Logs show no denies. What should you check?",
                            hint: "If the tunnel is established but traffic doesn't flow, it's usually a routing problem, not an encryption or authentication issue.",
                            options: [
                                "Route table on both ends, asymmetric routing, tunnel routes are correctly reversed (site A local = site B remote), and intermediate device return routes",
                                "Pre-shared keys match",
                                "Encryption algorithms match",
                                "Firewall licenses"
                            ],
                            correct: 0,
                            explanation: "Tunnel established = Phase 1 + 2 working. No traffic = routing problem. Common issues: missing return routes, NAT issues, asymmetric routing through different paths."
                        },
                        {
                            value: 400,
                            question: "You block China via Geolocation but legitimate Microsoft 365 traffic is failing. Users get intermittent access. Why?",
                            hint: "Cloud services like Microsoft 365 use content delivery networks that span the globe. Traffic may route through different countries.",
                            options: [
                                "Microsoft uses CDNs and regional data centers worldwide. US users may connect to Chinese Azure regions. Add Microsoft IP ranges to Geolocation exceptions.",
                                "Geolocation blocking is broken",
                                "Users are actually in China",
                                "Microsoft 365 is hosted in China"
                            ],
                            correct: 0,
                            explanation: "Cloud services use global CDNs. Microsoft 365 may serve from blocked countries. Solution: Geolocation exceptions for Microsoft IP ranges or use Application Control instead."
                        },
                        {
                            value: 500,
                            question: "Mobile VPN with SSL: users authenticate successfully but can't access internal resources. Connection shows established. Event log shows 'Unknown phase 1 proposal'. Describe complete troubleshooting methodology including certificate verification, client logs, tunnel route verification, and likely resolution.",
                            hint: "Phase 1 proposals include cipher suites, DH groups, and authentication methods. These must match between client and server capabilities.",
                            options: [
                                "Verify: Client cert in Local Machine store (not User) ‚Üí Check Fireware cipher suite matches client capabilities ‚Üí Confirm Group policy tunnel routes include internal subnets ‚Üí Review client diagnostic log for specific negotiation failure ‚Üí Likely: DH group or encryption mismatch in Phase 1 proposal ‚Üí Update Fireware IKE proposal settings",
                                "Reinstall VPN client",
                                "Regenerate all certificates",
                                "Disable firewall temporarily"
                            ],
                            correct: 0,
                            explanation: "Methodical approach: cert location matters for IKEv2, phase 1 proposal includes DH group + encryption + hash + auth method, all must match client capabilities. Diagnostic logging shows exact negotiation failure."
                        }
                    ]
                },
                {
                    name: "Email Security",
                    questions: [
                        {
                            value: 100,
                            question: "Which of these is a homoglyph attack?",
                            hint: "Homoglyphs use visually similar characters from different character sets or symbols that look like letters.",
                            options: [
                                "paypa1.com (number 1 instead of letter l)",
                                "paypal-security.com",
                                "secure-paypal.net",
                                "paypal.co"
                            ],
                            correct: 0,
                            explanation: "Homoglyph attacks use visually similar characters to deceive users. Number 1 looks like letter l, Cyrillic '–∞' looks like Latin 'a', etc."
                        },
                        {
                            value: 200,
                            question: "You examine email headers and see: 'spf=pass dkim=pass dmarc=fail'. What does this indicate?",
                            hint: "DMARC requires 'alignment' - a specific relationship between the From domain and the domains used in SPF/DKIM.",
                            options: [
                                "Email passed authentication but domain alignment failed (From domain doesn't match SPF/DKIM domain)",
                                "Email is definitely phishing",
                                "Email server is misconfigured",
                                "Email was rejected"
                            ],
                            correct: 0,
                            explanation: "DMARC requires alignment: the domain in From header must match the domain used in SPF/DKIM. Forwarding or sending via relay often causes this."
                        },
                        {
                            value: 300,
                            question: "A convincing email from 'CEO' asks you to purchase gift cards urgently for a client gift. Email address is ceo@company-group.com (your domain is company.com). What type of attack is this?",
                            hint: "This combines a fake domain that looks similar to the real one with impersonation of a high-authority figure.",
                            options: [
                                "Domain spoofing via similar domain + CEO fraud/Business Email Compromise",
                                "Account takeover",
                                "Phishing for credentials",
                                "Malware distribution"
                            ],
                            correct: 0,
                            explanation: "Classic BEC (Business Email Compromise) using typosquatting domain + authority/urgency. Always verify via separate communication channel using known contact info."
                        },
                        {
                            value: 400,
                            question: "Analyzing a suspicious email, you see: Return-Path: <legitimate@vendor.com>, From: <legitimate@vendor.com>, Reply-To: <attacker@evil.com>. What's happening?",
                            hint: "Email headers have multiple address fields. Reply-To directs where responses go, and attackers can set this field even if they can't spoof the From address.",
                            options: [
                                "Reply-To hijacking - email appears from legitimate sender but replies go to attacker",
                                "Account compromise",
                                "Server misconfiguration",
                                "This is normal email behavior"
                            ],
                            correct: 0,
                            explanation: "Attackers can't easily spoof From address past SPF/DKIM but CAN set Reply-To. User sees legitimate sender, replies go to attacker. Check full headers always."
                        },
                        {
                            value: 500,
                            question: "An employee received a series of emails over 2 weeks: (1) Vendor introduces new contact, (2) Normal business discussions, (3) 'Our bank account changed, please update records', (4) Invoice with new account details. Authentication passes. What sophisticated attack is this and how should organizations defend against it?",
                            hint: "This is an advanced attack that leverages compromised accounts and relationship building over time. Email authentication can't detect it because the account is legitimately compromised.",
                            options: [
                                "Advanced persistent social engineering via compromised vendor account. Defense: Verbal verification for ANY financial changes via known phone, transaction limits requiring dual approval, vendor financial change process with callbacks, security awareness training on pretexting attacks",
                                "Simple phishing - just block the sender",
                                "Malware infection - run antivirus",
                                "Internal fraud - fire the employee"
                            ],
                            correct: 0,
                            explanation: "This is real-world BEC: compromise vendor, build trust over time, then change payment details. Email authentication PASSES because account is legitimately compromised. Technology can't catch this - processes and awareness required."
                        }
                    ]
                },
                {
                    name: "Barracuda Email",
                    questions: [
                        {
                            value: 100,
                            question: "What is the default spam score threshold above which messages are typically quarantined in Barracuda ESG?",
                            hint: "The default threshold is between 5 and 6 on the spam score scale.",
                            options: [
                                "5.0-6.0",
                                "1.0-2.0",
                                "10.0",
                                "3.0"
                            ],
                            correct: 0,
                            explanation: "Default quarantine threshold is around 5.0-6.0. Lower scores (3.0-4.9) may be tagged but delivered. Higher thresholds (6.5+) reduce false positives."
                        },
                        {
                            value: 200,
                            question: "Users aren't receiving quarantine notification emails. What's the most common configuration issue?",
                            hint: "Quarantine notifications are scheduled to send at specific times during the day.",
                            options: [
                                "Notification delivery time not configured, or scheduled outside business hours (default 3:35 PM may be after users leave)",
                                "Barracuda is offline",
                                "Users' email addresses are wrong",
                                "Spam filter is too aggressive"
                            ],
                            correct: 0,
                            explanation: "Notification schedule defaults to 3:35 PM daily. If misconfigured or if users don't check email at that time, they miss notifications. Check QUARANTINE ‚Üí Notification Settings."
                        },
                        {
                            value: 300,
                            question: "You add sender@trusted-vendor.com to Allow List. What happens to emails from this sender?",
                            hint: "The Allow List is very powerful and bypasses ALL filtering, not just spam detection.",
                            options: [
                                "All spam AND malware scanning is bypassed - only use for truly trusted senders",
                                "Only spam filtering is bypassed, malware scanning still runs",
                                "Spam score is reduced by 50%",
                                "Nothing changes, just lower spam score"
                            ],
                            correct: 0,
                            explanation: "CRITICAL: Allow list bypasses ALL content inspection including malware scanning. If sender account is compromised, malware gets through. Use cautiously."
                        },
                        {
                            value: 400,
                            question: "Barracuda Cloud Archiver vs Cloud-to-Cloud Backup - when would you use EACH service?",
                            hint: "One is for compliance and long-term retention, the other is for disaster recovery and restoring deleted items.",
                            options: [
                                "Archiver: compliance/e-discovery with immutable long-term storage. C2C Backup: disaster recovery/point-in-time restoration of deleted items. Use BOTH for complete protection.",
                                "They're the same service with different names",
                                "Archiver for Office 365, C2C for on-premises",
                                "C2C Backup only for SharePoint"
                            ],
                            correct: 0,
                            explanation: "Different purposes: Archiver = compliance (tamper-proof, searchable, long retention). C2C Backup = disaster recovery (restore deleted mailboxes/folders/items). Most compliance-focused clients need both."
                        },
                        {
                            value: 500,
                            question: "Design a complete content filtering strategy for a financial services client to block: cryptocurrency scams, CEO fraud patterns, gift card requests, wire transfer urgency keywords, AND attachment types (.exe, .scr, .vbs) while minimizing false positives for legitimate urgent financial comms. Document your filter logic, testing methodology, and whitelisting approach.",
                            hint: "Effective content filtering combines keyword detection with scoring, separate policies for dangerous attachments, verified sender whitelisting, and a testing period before full implementation.",
                            options: [
                                "Create intent-based filters: (crypto+urgent+investment) OR (CEO+urgent+confidential+gift card) OR (wire transfer+today+urgent) with score +3.0. Block .exe/.scr/.vbs attachments outright. Create Sender Whitelist for CFO + financial institutions using domain verification. Test mode for 1 week logging to QUARANTINE, review false positives, adjust. Implement with BLOCK action for attachments, TAG+QUARANTINE for content. Whitelist requires both domain match AND DKIM pass.",
                                "Block all emails containing 'urgent' or 'Bitcoin'",
                                "Enable default spam filtering only",
                                "Add all financial institutions to allow list"
                            ],
                            correct: 0,
                            explanation: "Complete solution requires: multi-keyword logic with scoring, absolute blocks for dangerous files, verification-based whitelisting (not just domain), test period with review process, separate actions for different threat levels. Single-keyword blocking creates excessive false positives."
                        }
                    ]
                },
                {
                    name: "Mixed Topics",
                    questions: [
                        {
                            value: 100,
                            question: "A user can't access a SharePoint file. You confirm they're in the correct Azure AD group with permissions. What should you check next?",
                            hint: "Permissions at the file or folder level can override broader permissions.",
                            options: [
                                "Whether permission inheritance is broken on that file/folder with unique permissions",
                                "User's internet connection",
                                "SharePoint service health",
                                "User's browser version"
                            ],
                            correct: 0,
                            explanation: "Broken inheritance with unique permissions is the most common cause of 'but they're in the right group' access issues in SharePoint."
                        },
                        {
                            value: 200,
                            question: "Exchange Online mailbox shows 'LitigationHoldEnabled: True' but user reports emails older than 3 years are missing. Where is the data?",
                            hint: "Litigation Hold preserves ALL deleted items in a special folder that may require special access if it's large.",
                            options: [
                                "Recoverable Items folder (may require archive mailbox to access if size exceeds primary limits)",
                                "Data was deleted and is gone",
                                "Audit log only",
                                "On-premises server"
                            ],
                            correct: 0,
                            explanation: "Litigation Hold preserves ALL items in Recoverable Items folder. If not visible, archive mailbox may be needed or folder size limits reached."
                        },
                        {
                            value: 300,
                            question: "A synchronized user can sign in to Azure AD but can't access applications. Sign-in logs show successful authentication. What hybrid identity configuration might cause this?",
                            hint: "Successful sign-in but blocked application access often indicates a policy evaluating AFTER authentication.",
                            options: [
                                "Conditional Access policy blocking based on location, device compliance, or app requirements",
                                "Password Hash Sync not configured",
                                "Azure AD Connect is offline",
                                "User license not assigned"
                            ],
                            correct: 0,
                            explanation: "Successful sign-in but blocked app access = Conditional Access evaluation. Check CA policies in Sign-in Logs ‚Üí Conditional Access tab."
                        },
                        {
                            value: 400,
                            question: "Client reports intermittent VPN disconnections every 20-30 minutes. WatchGuard BOVPN tunnel re-establishes automatically. What's the likely cause?",
                            hint: "Regular intervals like 20-30 minutes suggest a timeout or lifetime expiration. VPN has two phases, each with their own lifetimes.",
                            options: [
                                "Phase 1 SA lifetime too short or Phase 2 rekey failing before Phase 1 expires. Increase Phase 1 lifetime to exceed Phase 2 lifetime by 10+ minutes.",
                                "Internet connection is unstable",
                                "Firewall is overloaded",
                                "VPN license expired"
                            ],
                            correct: 0,
                            explanation: "20-30 min intervals suggest lifetime expiration. Phase 1 SA lifetime must exceed Phase 2 lifetime to allow rekey. Common misconfiguration: both set to 28800 seconds."
                        },
                        {
                            value: 500,
                            question: "Client scenario: 50 users, hybrid identity (Azure AD Connect with PHS), Exchange Online, SharePoint Online, Egnyte with SSO. 5 executives need MFA, others don't. Gift card email scams targeting CEO are increasing. Shared mailbox for customerservice@ has 100GB of email. Design your complete security and compliance implementation including authentication, conditional access, email security, storage management, and monitoring. Justify each decision.",
                            hint: "A complete solution addresses authentication method selection, risk-based access policies, targeted email filtering, storage lifecycle management, and proactive monitoring - all tailored to specific requirements and balanced with usability.",
                            options: [
                                "Authentication: PHS with Seamless SSO (simplicity + reliability). CA: MFA required for executives group (user-based targeting), block legacy auth globally except VPN Named Location. Email: Barracuda content filter for CEO fraud keywords + gift cards, impersonation protection for executives. Storage: Convert old customerservice@ to shared (if under 50GB) or keep licensed, enable archive, retention policy 2-year online/archive remainder, legal hold if needed. Monitoring: Exchange message trace alerts for executive senders + external + urgent keywords, Azure AD sign-in log review weekly, Barracuda quarantine review daily. Justification: Balanced security without user friction, targeted controls for high-risk users, proactive monitoring for BEC patterns.",
                                "Enable MFA for everyone, block all external sharing, delete old emails",
                                "Just use Security Defaults and default settings",
                                "Implement ADFS for authentication"
                            ],
                            correct: 0,
                            explanation: "Complete MSP solution requires: appropriate auth method for scenario, risk-based conditional access, targeted email protection, storage lifecycle management, and monitoring. One-size-fits-all (Security Defaults) doesn't meet nuanced requirements. Each component has justification for client needs and budget."
                        }
                    ]
                }
            ]
        };

        // Game state
        let currentPlayer = '';
        let currentScore = 0;
        let answeredQuestions = new Set();
        let questionAttempts = {}; // Track attempts per question
        let questionHints = {}; // Track hints used
        let questionScores = {}; // Track actual points earned per question
        let currentQuestion = null;
        let gameStartTime = null;
        let gameEndTime = null;
        const GAME_DURATION = 72 * 60 * 60 * 1000; // 72 hours in milliseconds

        // Cookie functions
        function setCookie(name, value, days) {
            const date = new Date();
            date.setTime(date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${JSON.stringify(value)};expires=${date.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) {
                    try {
                        return JSON.parse(c.substring(nameEQ.length, c.length));
                    } catch(e) {
                        return null;
                    }
                }
            }
            return null;
        }

        function deleteCookie(name) {
            document.cookie = name + '=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/';
        }

        // Timer function
        function updateTimer() {
            if (!gameStartTime) return;
            
            const now = Date.now();
            const elapsed = now - gameStartTime;
            const remaining = GAME_DURATION - elapsed;
            
            if (remaining <= 0) {
                document.getElementById('timeRemaining').textContent = '00:00:00';
                document.getElementById('timeRemaining').style.color = '#f44336';
                expireGame();
                return;
            }
            
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
            
            const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('timeRemaining').textContent = timeStr;
            
            if (hours < 6) {
                document.getElementById('timeRemaining').style.color = '#ff9800';
            }
            if (hours < 1) {
                document.getElementById('timeRemaining').style.color = '#f44336';
            }
        }

        function expireGame() {
            const expired = document.createElement('div');
            expired.className = 'expired-message';
            expired.innerHTML = `
                <h2>‚è∞ Time's Up!</h2>
                <p>Your 72-hour challenge period has expired.</p>
                <p>Final Score: ${currentScore} points</p>
                <button class="btn-primary" onclick="downloadReport()">Download Final Report</button>
                <br><br>
                <button class="btn-secondary" onclick="resetGame()">Start New Game</button>
            `;
            document.getElementById('gameArea').innerHTML = '';
            document.getElementById('gameArea').appendChild(expired);
            document.getElementById('gameArea').style.display = 'block';
            
            // Auto-download report
            setTimeout(() => {
                downloadReport();
            }, 1000);
        }

        // Initialize game
        function initGame() {
            const savedGame = getCookie('msp_ctf_game');
            if (savedGame && savedGame.gameStartTime) {
                const elapsed = Date.now() - savedGame.gameStartTime;
                if (elapsed < GAME_DURATION) {
                    if (confirm(`Continue game as ${savedGame.playerName} with ${savedGame.score} points?`)) {
                        loadSavedGame(savedGame);
                        return;
                    }
                } else {
                    alert('Your previous game expired. Starting fresh!');
                    deleteCookie('msp_ctf_game');
                }
            }
            showStartScreen();
        }

        function showStartScreen() {
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('gameArea').style.display = 'none';
        }

        function startGame() {
            const playerName = document.getElementById('playerNameInput').value.trim();
            if (!playerName) {
                alert('Please enter your name!');
                return;
            }

            currentPlayer = playerName;
            currentScore = 0;
            answeredQuestions.clear();
            questionAttempts = {};
            questionHints = {};
            questionScores = {};
            gameStartTime = Date.now();
            gameEndTime = null;

            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            document.getElementById('playerName').textContent = currentPlayer;
            document.getElementById('currentScore').textContent = currentScore;

            buildGameBoard();
            saveGame();
            
            // Start timer
            updateTimer();
            setInterval(updateTimer, 1000);
        }

        function buildGameBoard() {
            const gameBoard = document.getElementById('gameBoard');
            gameBoard.innerHTML = '';

            // Add category headers
            gameData.categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                categoryDiv.textContent = category.name;
                gameBoard.appendChild(categoryDiv);
            });

            // Add question boxes (5 difficulty levels)
            for (let i = 0; i < 5; i++) {
                gameData.categories.forEach((category, catIndex) => {
                    const question = category.questions[i];
                    const questionBox = document.createElement('div');
                    questionBox.className = 'question-box';
                    questionBox.textContent = `$${question.value}`;
                    questionBox.dataset.category = catIndex;
                    questionBox.dataset.questionIndex = i;

                    const questionId = `${catIndex}-${i}`;
                    const attempts = questionAttempts[questionId] || 0;
                    
                    if (answeredQuestions.has(questionId)) {
                        questionBox.classList.add('answered');
                    } else if (attempts >= 2) {
                        questionBox.classList.add('failed');
                        const badge = document.createElement('div');
                        badge.className = 'attempts-badge';
                        badge.textContent = 'No Points';
                        questionBox.appendChild(badge);
                        questionBox.onclick = () => openQuestion(catIndex, i);
                    } else if (attempts === 1) {
                        questionBox.classList.add('partial');
                        const badge = document.createElement('div');
                        badge.className = 'attempts-badge';
                        badge.textContent = '1 Try Left';
                        questionBox.appendChild(badge);
                        questionBox.onclick = () => openQuestion(catIndex, i);
                    } else {
                        questionBox.onclick = () => openQuestion(catIndex, i);
                    }

                    gameBoard.appendChild(questionBox);
                });
            }

            updateProgress();
        }

        function openQuestion(categoryIndex, questionIndex) {
            const category = gameData.categories[categoryIndex];
            const question = category.questions[questionIndex];
            const questionId = `${categoryIndex}-${questionIndex}`;
            const attempts = questionAttempts[questionId] || 0;
            const hintsUsed = questionHints[questionId] || 0;
            
            currentQuestion = { categoryIndex, questionIndex, question, questionId };

            document.getElementById('questionValue').textContent = `$${question.value} - ${category.name}`;
            document.getElementById('questionText').textContent = question.question;

            // Show/hide hint button and section
            const hintBtn = document.getElementById('hintBtn');
            const hintSection = document.getElementById('hintSection');
            
            if (hintsUsed > 0) {
                hintSection.classList.add('active');
                document.getElementById('hintText').textContent = `üí° Hint: ${question.hint}`;
                hintBtn.style.display = 'none';
            } else {
                hintSection.classList.remove('active');
                hintBtn.style.display = 'inline-block';
                if (attempts >= 2) {
                    hintBtn.textContent = 'üí° Show Hint (No Points Available)';
                }
            }

            const optionsContainer = document.getElementById('answerOptions');
            optionsContainer.innerHTML = '';

            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'answer-btn';
                button.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                button.onclick = () => submitAnswer(index);
                optionsContainer.appendChild(button);
            });

            document.getElementById('feedback').style.display = 'none';
            document.getElementById('questionModal').classList.add('active');
        }

        function requestHint() {
            const { question, questionId } = currentQuestion;
            const attempts = questionAttempts[questionId] || 0;
            
            if (attempts >= 2) {
                // No points available anyway, show hint for free
                confirmHint();
                return;
            }
            
            const hintsUsed = questionHints[questionId] || 0;
            const currentPotential = question.value * Math.pow(0.9, hintsUsed);
            const afterHintPotential = question.value * Math.pow(0.9, hintsUsed + 1);
            
            document.getElementById('currentPotential').textContent = Math.round(currentPotential);
            document.getElementById('afterHintPotential').textContent = Math.round(afterHintPotential);
            document.getElementById('hintConfirmModal').classList.add('active');
        }

        function confirmHint() {
            closeHintConfirm();
            const { question, questionId } = currentQuestion;
            questionHints[questionId] = (questionHints[questionId] || 0) + 1;
            
            const hintSection = document.getElementById('hintSection');
            hintSection.classList.add('active');
            document.getElementById('hintText').textContent = `üí° Hint: ${question.hint}`;
            document.getElementById('hintBtn').style.display = 'none';
            
            saveGame();
        }

        function closeHintConfirm() {
            document.getElementById('hintConfirmModal').classList.remove('active');
        }

        function submitAnswer(selectedIndex) {
            const { categoryIndex, questionIndex, question, questionId } = currentQuestion;
            const attempts = questionAttempts[questionId] || 0;
            const hintsUsed = questionHints[questionId] || 0;

            // Disable all buttons
            const buttons = document.querySelectorAll('.answer-btn');
            buttons.forEach(btn => btn.disabled = true);

            const feedback = document.getElementById('feedback');
            const isCorrect = selectedIndex === question.correct;

            // Visual feedback on buttons
            buttons[selectedIndex].classList.add(isCorrect ? 'correct' : 'incorrect');
            if (!isCorrect) {
                buttons[question.correct].classList.add('correct');
            }

            // Calculate points with hint penalty
            const basePoints = question.value;
            const pointsAfterHints = Math.round(basePoints * Math.pow(0.9, hintsUsed));
            
            // Show feedback
            feedback.style.display = 'block';
            if (isCorrect) {
                if (attempts < 2) {
                    // Still eligible for points
                    feedback.className = 'feedback correct';
                    let message = `<strong>‚úì Correct! +${pointsAfterHints} points</strong>`;
                    if (hintsUsed > 0) {
                        message += `<br><small>(${basePoints} points - ${hintsUsed * 10}% hint penalty)</small>`;
                    }
                    message += `<br>${question.explanation}`;
                    feedback.innerHTML = message;
                    currentScore += pointsAfterHints;
                    questionScores[questionId] = pointsAfterHints;
                    answeredQuestions.add(questionId);
                } else {
                    // Correct but no points
                    feedback.className = 'feedback correct';
                    feedback.innerHTML = `<strong>‚úì Correct Answer!</strong><br>However, you've used both attempts, so no points awarded.<br>${question.explanation}`;
                    answeredQuestions.add(questionId);
                }
            } else {
                questionAttempts[questionId] = attempts + 1;
                if (attempts + 1 >= 2) {
                    feedback.className = 'feedback incorrect';
                    feedback.innerHTML = `<strong>‚úó Incorrect - Out of Attempts</strong><br>The correct answer was: <strong>${question.options[question.correct]}</strong><br>${question.explanation}<br><small>You can still try again, but no points will be awarded.</small>`;
                } else {
                    feedback.className = 'feedback retry';
                    feedback.innerHTML = `<strong>‚úó Incorrect - Try Again!</strong><br>You have 1 more attempt for this question.<br><small>Hint: Consider using the hint button if you're unsure.</small>`;
                }
            }

            document.getElementById('currentScore').textContent = currentScore;
            saveGame();
            updateProgress();

            // Auto close after delay
            setTimeout(() => {
                closeModal();
                buildGameBoard(); // Rebuild to show updated state
            }, isCorrect ? 4000 : 5000);
        }

        function closeModal() {
            document.getElementById('questionModal').classList.remove('active');
            currentQuestion = null;
        }

        function updateProgress() {
            const totalQuestions = gameData.categories.length * 5;
            const answeredCount = answeredQuestions.size;
            const percentage = (answeredCount / totalQuestions) * 100;
            document.getElementById('progressBar').style.width = `${percentage}%`;

            if (answeredCount === totalQuestions) {
                gameEndTime = Date.now();
                setTimeout(() => {
                    endGame();
                }, 2000);
            }
        }

        function saveGame() {
            const gameState = {
                playerName: currentPlayer,
                score: currentScore,
                answeredQuestions: Array.from(answeredQuestions),
                questionAttempts: questionAttempts,
                questionHints: questionHints,
                questionScores: questionScores,
                gameStartTime: gameStartTime,
                gameEndTime: gameEndTime,
                timestamp: Date.now()
            };
            setCookie('msp_ctf_game', gameState, 7);
        }

        function loadSavedGame(save) {
            currentPlayer = save.playerName;
            currentScore = save.score;
            answeredQuestions = new Set(save.answeredQuestions);
            questionAttempts = save.questionAttempts || {};
            questionHints = save.questionHints || {};
            questionScores = save.questionScores || {};
            gameStartTime = save.gameStartTime;
            gameEndTime = save.gameEndTime;

            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            document.getElementById('playerName').textContent = currentPlayer;
            document.getElementById('currentScore').textContent = currentScore;

            buildGameBoard();
            updateTimer();
            setInterval(updateTimer, 1000);
        }

        function endGame() {
            gameEndTime = Date.now();
            saveGame();
            alert(`üéâ Game Complete!\n\nCongratulations ${currentPlayer}!\nFinal Score: ${currentScore} points\n\nDownloading your performance report...`);
            downloadReport();
        }

        function showReport() {
            generateReport();
            document.getElementById('reportModal').classList.add('active');
        }

        function closeReport() {
            document.getElementById('reportModal').classList.remove('active');
        }

        function generateReport() {
            const totalQuestions = gameData.categories.length * 5;
            const answeredCount = answeredQuestions.size;
            const totalHintsUsed = Object.values(questionHints).reduce((a, b) => a + b, 0);
            const totalAttempts = Object.values(questionAttempts).reduce((a, b) => a + b, 0);
            const maxPossibleScore = gameData.categories.reduce((sum, cat) => 
                sum + cat.questions.reduce((qsum, q) => qsum + q.value, 0), 0);
            const completionPercent = Math.round((answeredCount / totalQuestions) * 100);
            const scorePercent = Math.round((currentScore / maxPossibleScore) * 100);
            
            // Calculate time taken
            const timeTaken = gameEndTime ? gameEndTime - gameStartTime : Date.now() - gameStartTime;
            const hoursTaken = Math.floor(timeTaken / (1000 * 60 * 60));
            const minutesTaken = Math.floor((timeTaken % (1000 * 60 * 60)) / (1000 * 60));
            
            // Category performance
            let categoryHTML = '';
            gameData.categories.forEach((category, catIndex) => {
                let categoryScore = 0;
                let categoryMax = 0;
                let categoryAnswered = 0;
                
                category.questions.forEach((q, qIndex) => {
                    const qId = `${catIndex}-${qIndex}`;
                    categoryMax += q.value;
                    if (answeredQuestions.has(qId)) {
                        categoryAnswered++;
                        categoryScore += questionScores[qId] || 0;
                    }
                });
                
                const categoryPercent = categoryMax > 0 ? Math.round((categoryScore / categoryMax) * 100) : 0;
                const barClass = categoryPercent >= 70 ? '' : categoryPercent >= 40 ? 'medium' : 'low';
                
                categoryHTML += `
                    <div class="category-performance">
                        <div class="category-name">${category.name}</div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin: 5px 0;">
                            <span>${categoryAnswered}/5 completed</span>
                            <span>${categoryScore}/${categoryMax} points (${categoryPercent}%)</span>
                        </div>
                        <div class="performance-bar">
                            <div class="performance-fill ${barClass}" style="width: ${categoryPercent}%"></div>
                        </div>
                    </div>
                `;
            });
            
            // Strengths and weaknesses
            const categoryScores = gameData.categories.map((cat, idx) => {
                let score = 0;
                let max = 0;
                cat.questions.forEach((q, qIdx) => {
                    const qId = `${idx}-${qIdx}`;
                    max += q.value;
                    if (answeredQuestions.has(qId)) {
                        score += questionScores[qId] || 0;
                    }
                });
                return { name: cat.name, score, max, percent: max > 0 ? (score / max) * 100 : 0 };
            });
            
            categoryScores.sort((a, b) => b.percent - a.percent);
            const strengths = categoryScores.slice(0, 3).map(c => c.name).join(', ');
            const improvements = categoryScores.slice(-3).reverse().map(c => c.name).join(', ');
            
            const reportHTML = `
                <div class="report-section">
                    <h3>üìà Overall Performance</h3>
                    <div class="stat-grid">
                        <div class="stat-card">
                            <div class="stat-value">${currentScore}</div>
                            <div class="stat-label">Total Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${scorePercent}%</div>
                            <div class="stat-label">Score Efficiency</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${answeredCount}/${totalQuestions}</div>
                            <div class="stat-label">Questions Completed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${completionPercent}%</div>
                            <div class="stat-label">Completion Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${totalHintsUsed}</div>
                            <div class="stat-label">Hints Used</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${hoursTaken}h ${minutesTaken}m</div>
                            <div class="stat-label">Time Spent</div>
                        </div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h3>üí™ Your Strengths</h3>
                    <p>You performed best in: <strong>${strengths}</strong></p>
                    <p>These areas show strong understanding. Consider mentoring others or tackling advanced scenarios in these domains.</p>
                </div>
                
                <div class="report-section">
                    <h3>üìö Areas for Improvement</h3>
                    <p>Focus your learning on: <strong>${improvements}</strong></p>
                    <p>Additional training, documentation review, or hands-on practice in these areas would be beneficial.</p>
                </div>
                
                <div class="report-section">
                    <h3>üìä Category Breakdown</h3>
                    ${categoryHTML}
                </div>
                
                <div class="report-section">
                    <h3>üí° Recommendations</h3>
                    <ul>
                        ${totalHintsUsed > 15 ? '<li>Consider reviewing fundamental concepts before retaking - you used many hints</li>' : ''}
                        ${scorePercent < 50 ? '<li>Schedule follow-up training sessions on the weak areas identified above</li>' : ''}
                        ${completionPercent < 80 ? '<li>Consider retaking to complete all challenges and maximize learning</li>' : ''}
                        ${scorePercent >= 80 ? '<li>Excellent performance! Consider advanced certifications or specialized training</li>' : ''}
                        ${totalAttempts > answeredCount * 1.5 ? '<li>Take more time to research before answering - multiple attempts indicate rushing</li>' : ''}
                    </ul>
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = reportHTML;
        }

        function downloadReport() {
            generateReport();
            const reportElement = document.getElementById('reportContent');
            
            const reportText = `
MSP TECHNICIAN CTF TRAINING - PERFORMANCE REPORT
Generated: ${new Date().toLocaleString()}
Player: ${currentPlayer}
=================================================

OVERALL PERFORMANCE
-------------------
Total Score: ${currentScore} points
Score Efficiency: ${Math.round((currentScore / gameData.categories.reduce((sum, cat) => 
    sum + cat.questions.reduce((qsum, q) => qsum + q.value, 0), 0)) * 100)}%
Questions Completed: ${answeredQuestions.size}/${gameData.categories.length * 5}
Hints Used: ${Object.values(questionHints).reduce((a, b) => a + b, 0)}
Failed Attempts: ${Object.values(questionAttempts).reduce((a, b) => a + b, 0)}

CATEGORY BREAKDOWN
------------------
${gameData.categories.map((cat, idx) => {
    let score = 0;
    let max = 0;
    let completed = 0;
    cat.questions.forEach((q, qIdx) => {
        const qId = `${idx}-${qIdx}`;
        max += q.value;
        if (answeredQuestions.has(qId)) {
            completed++;
            score += questionScores[qId] || 0;
        }
    });
    return `${cat.name}: ${score}/${max} points (${completed}/5 completed) - ${Math.round((score/max)*100)}%`;
}).join('\n')}

STRENGTHS
---------
${gameData.categories.map((cat, idx) => {
    let score = 0;
    let max = 0;
    cat.questions.forEach((q, qIdx) => {
        const qId = `${idx}-${qIdx}`;
        max += q.value;
        if (answeredQuestions.has(qId)) {
            score += questionScores[qId] || 0;
        }
    });
    return { name: cat.name, percent: max > 0 ? (score / max) * 100 : 0 };
}).sort((a, b) => b.percent - a.percent).slice(0, 3).map(c => `- ${c.name} (${Math.round(c.percent)}%)`).join('\n')}

AREAS FOR IMPROVEMENT
--------------------
${gameData.categories.map((cat, idx) => {
    let score = 0;
    let max = 0;
    cat.questions.forEach((q, qIdx) => {
        const qId = `${idx}-${qIdx}`;
        max += q.value;
        if (answeredQuestions.has(qId)) {
            score += questionScores[qId] || 0;
        }
    });
    return { name: cat.name, percent: max > 0 ? (score / max) * 100 : 0 };
}).sort((a, b) => a.percent - b.percent).slice(0, 3).map(c => `- ${c.name} (${Math.round(c.percent)}%)`).join('\n')}

=================================================
This report should be reviewed with your training coordinator.
Continue learning through Microsoft Learn, vendor documentation,
and hands-on practice in identified weak areas.
            `;
            
            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MSP-CTF-Report-${currentPlayer}-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showInstructions() {
            document.getElementById('instructionsModal').classList.add('active');
        }

        function closeInstructions() {
            document.getElementById('instructionsModal').classList.remove('active');
        }

        function showLeaderboard() {
            const leaderboard = getCookie('msp_ctf_leaderboard') || [];
            const content = document.getElementById('leaderboardContent');

            if (leaderboard.length === 0) {
                content.innerHTML = '<p style="text-align: center; padding: 20px;">No scores yet. Be the first to complete the game!</p>';
            } else {
                let html = '<div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px;"><table style="width: 100%; border-collapse: collapse;">';
                html += '<tr style="border-bottom: 2px solid var(--accent-red);"><th style="text-align: left; padding: 10px;">Rank</th><th style="text-align: left; padding: 10px;">Name</th><th style="text-align: center; padding: 10px;">Score</th><th style="text-align: center; padding: 10px;">Date</th></tr>';

                leaderboard.forEach((entry, index) => {
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                    html += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 10px;">${medal} ${index + 1}</td>
                        <td style="padding: 10px;">${entry.name}</td>
                        <td style="text-align: center; padding: 10px; font-weight: bold; color: var(--accent-red);">${entry.score}</td>
                        <td style="text-align: center; padding: 10px;">${entry.date}</td>
                    </tr>`;
                });

                html += '</table></div>';
                content.innerHTML = html;
            }

            document.getElementById('leaderboardModal').classList.add('active');
        }

        function closeLeaderboard() {
            document.getElementById('leaderboardModal').classList.remove('active');
        }

        function saveToLeaderboard() {
            const leaderboard = getCookie('msp_ctf_leaderboard') || [];
            leaderboard.push({
                name: currentPlayer,
                score: currentScore,
                date: new Date().toLocaleDateString(),
                timestamp: Date.now()
            });

            leaderboard.sort((a, b) => b.score - a.score);
            const top50 = leaderboard.slice(0, 50);

            setCookie('msp_ctf_leaderboard', top50, 365);
        }

        function resetGame() {
            if (confirm('Are you sure you want to start a new game? Current progress will be lost.')) {
                // Save current score to leaderboard if game was completed
                if (answeredQuestions.size > 0) {
                    saveToLeaderboard();
                }
                
                deleteCookie('msp_ctf_game');
                currentPlayer = '';
                currentScore = 0;
                answeredQuestions.clear();
                questionAttempts = {};
                questionHints = {};
                questionScores = {};
                gameStartTime = null;
                gameEndTime = null;
                showStartScreen();
                document.getElementById('playerNameInput').value = '';
            }
        }

        // Initialize on page load
        window.onload = initGame;

        // Close modals on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeLeaderboard();
                closeInstructions();
                closeHintConfirm();
                closeReport();
            }
        });
    </script>
</body>
</html>